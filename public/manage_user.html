<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω Ng∆∞·ªùi D√πng & Kh√≥a H·ªçc - E-Learning</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <style>
      body {
        background-color: #f8f9fa;
      }
      .container {
        max-width: 1200px;
        margin: auto;
        padding-top: 30px;
      }
      .card-header {
        background-color: #007bff;
        color: white;
      }
      .bg-success .card-header {
        background-color: #198754 !important;
      }
      .alert-fixed {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
      }
      .btn-action {
        margin: 0 3px;
      }
      /* CSS cho th√¥ng b√°o Alert */
      .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center text-primary mb-5">·ª®ng d·ª•ng E-Learning BTL2</h1>

      <div id="user-management" class="card shadow-sm mb-5">
        <div class="card-header">
          <h5 class="mb-0">‚öôÔ∏è 1. Qu·∫£n l√Ω Ng∆∞·ªùi D√πng (Th·ªß t·ª•c 2.1)</h5>
        </div>
        <div class="card-body">
          <div id="alertContainer" class="alert-fixed"></div>

          <form id="userForm">
            <input type="hidden" id="userId" />

            <div class="row mb-3">
              <div class="col-md-3">
                <label class="form-label">ID (S·ª≠a/X√≥a):</label>
                <input
                  type="text"
                  class="form-control"
                  id="id"
                  placeholder="Nh·∫≠p ID"
                />
              </div>
              <div class="col-md-3">
                <label class="form-label">Email:</label>
                <input type="email" class="form-control" id="email" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">First Name:</label>
                <input
                  type="text"
                  class="form-control"
                  id="firstName"
                  required
                />
              </div>
              <div class="col-md-3">
                <label class="form-label">Last Name:</label>
                <input
                  type="text"
                  class="form-control"
                  id="lastName"
                  required
                />
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-3">
                <label class="form-label">Username:</label>
                <input
                  type="text"
                  class="form-control"
                  id="username"
                  required
                />
              </div>
              <div class="col-md-3">
                <label class="form-label">Password:</label>
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  required
                />
              </div>
              <div class="col-md-3">
                <label class="form-label">Role:</label>
                <select class="form-select" id="role" required>
                  <option value="student">Student</option>
                  <option value="teacher">Teacher</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Bank Account:</label>
                <input
                  type="text"
                  class="form-control"
                  id="bankAccount"
                  required
                />
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-12">
                <label class="form-label">Bank Name:</label>
                <input
                  type="text"
                  class="form-control"
                  id="bankName"
                  required
                />
              </div>
            </div>

            <button type="submit" id="btnAdd" class="btn btn-primary me-2">
              <i class="fas fa-plus"></i> Th√™m M·ªõi
            </button>
            <button type="button" id="btnUpdate" class="btn btn-info me-2">
              <i class="fas fa-edit"></i> C·∫≠p Nh·∫≠t
            </button>
            <button type="button" id="btnDelete" class="btn btn-danger">
              <i class="fas fa-trash-alt"></i> X√≥a
            </button>
          </form>
        </div>
      </div>

      <div id="course-list" class="card shadow-sm">
        <div class="card-header bg-success">
          <h5 class="mb-0">
            üìö 2. Danh s√°ch Kh√≥a h·ªçc Gi√°o vi√™n (Th·ªß t·ª•c 2.3 & CRUD)
          </h5>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">Teacher ID:</label>
              <input
                type="text"
                class="form-control"
                id="searchTeacherId"
                placeholder="Nh·∫≠p ID Gi√°o vi√™n"
                value="1"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Gi√° T·ªëi ƒëa (Filter):</label>
              <input
                type="number"
                class="form-control"
                id="searchMaxPrice"
                placeholder="Nh·∫≠p gi√° t·ªëi ƒëa (v√≠ d·ª•: 100)"
                value="999999"
              />
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button id="btnSearchCourses" class="btn btn-success w-100">
                <i class="fas fa-search"></i> T√¨m Ki·∫øm & S·∫Øp X·∫øp
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table
              id="courseTable"
              class="table table-striped table-bordered table-hover"
            >
              <thead>
                <tr>
                  <th>ID Kh√≥a h·ªçc</th>
                  <th>T√™n Kh√≥a h·ªçc</th>
                  <th>Gi√° (USD)</th>
                  <th>T√™n Gi√°o vi√™n</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- KHAI B√ÅO C√ÅC H·∫∞NG V√Ä BI·∫æN TO√ÄN C·ª§C ---
      const API_URL = "/api/users"; // API cho User (CRUD v√† GET courses)
      const COURSE_API_URL = "/api/courses"; // API cho Course (CRUD)
      const courseTableBody = document.querySelector("#courseTable tbody");
      let currentCourses = []; // D√πng ƒë·ªÉ l∆∞u d·ªØ li·ªáu kh√≥a h·ªçc hi·ªán t·∫°i (cho S·ª≠a/X√≥a)

      // H√†m hi·ªÉn th·ªã th√¥ng b√°o c·ªë ƒë·ªãnh (Alerts)
      function showAlert(content, type = "success") {
        const alertHtml = `
              <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                  ${content}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
          `;
        const container = document.getElementById("alertContainer");
        // Clear old alerts and show new one
        container.innerHTML = alertHtml;
        setTimeout(() => {
          const alertElement = container.querySelector(".alert");
          if (alertElement) new bootstrap.Alert(alertElement).close();
        }, 5000);
      }

      // --- LOGIC FORM USER (CRUD) ---

      function getFormData() {
        return {
          id: document.getElementById("id").value,
          email: document.getElementById("email").value,
          firstName: document.getElementById("firstName").value,
          lastName: document.getElementById("lastName").value,
          username: document.getElementById("username").value,
          password: document.getElementById("password").value,
          role: document.getElementById("role").value,
          bankName: document.getElementById("bankName").value,
          bankAccount: document.getElementById("bankAccount").value,
        };
      }

      document
        .getElementById("userForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const data = getFormData();
          try {
            const response = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await response.json();
            if (response.ok) {
              showAlert(
                "Th√™m m·ªõi User th√†nh c√¥ng! " + result.message,
                "success"
              );
              document.getElementById("userForm").reset();
            } else {
              showAlert("L·ªói Th√™m: " + result.error, "danger");
            }
          } catch (error) {
            showAlert("L·ªói k·∫øt n·ªëi: " + error.message, "danger");
          }
        });

      document
        .getElementById("btnUpdate")
        .addEventListener("click", async () => {
          const data = getFormData();
          const userId = data.id;
          if (!userId) {
            showAlert("Vui l√≤ng nh·∫≠p ID User c·∫ßn c·∫≠p nh·∫≠t.", "warning");
            return;
          }
          try {
            const response = await fetch(`${API_URL}/${userId}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await response.json();
            if (response.ok) {
              showAlert(`C·∫≠p nh·∫≠t User ID ${userId} th√†nh c√¥ng!`, "success");
            } else {
              showAlert("L·ªói C·∫≠p Nh·∫≠t: " + result.error, "danger");
            }
          } catch (error) {
            showAlert("L·ªói k·∫øt n·ªëi: " + error.message, "danger");
          }
        });

      document
        .getElementById("btnDelete")
        .addEventListener("click", async () => {
          const userId = document.getElementById("id").value;
          if (
            !userId ||
            !confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a User ID ${userId}?`)
          ) {
            return;
          }
          try {
            const response = await fetch(`${API_URL}/${userId}`, {
              method: "DELETE",
            });
            const result = await response.json();
            if (response.ok) {
              showAlert(
                `X√≥a User ID ${userId} th√†nh c√¥ng! ${result.message}`,
                "success"
              );
              document.getElementById("userForm").reset();
            } else {
              showAlert("L·ªói X√≥a Nghi·ªáp V·ª•: " + result.error, "danger");
            }
          } catch (error) {
            showAlert("L·ªói k·∫øt n·ªëi: " + error.message, "danger");
          }
        });

      // --- LOGIC S·ª¨A/X√ìA KH√ìA H·ªåC (M·ªöI) ---

      // H√†m S·ª≠a Kh√≥a h·ªçc
      function editCourse(courseId) {
        // S·ª≠ d·ª•ng c.courseId (gi·ªØ t√™n thu·ªôc t√≠nh c≈© ƒë·ªÉ kh·ªõp v·ªõi Backend hi·ªán t·∫°i c·ªßa b·∫°n)
        const course = currentCourses.find((c) => c.courseId == courseId);
        if (!course) return;

        // Gi·∫£ ƒë·ªãnh ng√¥n ng·ªØ m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ trong d·ªØ li·ªáu tr·∫£ v·ªÅ
        const currentLanguage = course.language || "Vietnamese";

        // S·ª≠ d·ª•ng course.courseName (gi·ªØ t√™n thu·ªôc t√≠nh c≈©)
        const newPrice = prompt(
          `Nh·∫≠p GI√Å M·ªöI cho kh√≥a h·ªçc "${course.courseName}" (Gi√° c≈©: $${course.price}):`,
          course.price
        );

        if (newPrice !== null && !isNaN(newPrice) && parseFloat(newPrice) > 0) {
          const newPriceFloat = parseFloat(newPrice);

          fetch(`${COURSE_API_URL}/${courseId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              // G·ª≠i ƒë·ªß tham s·ªë cho th·ªß t·ª•c update_course
              name: course.courseName, // D√πng t√™n c≈© nh∆∞ng g·ª≠i l√™n server d∆∞·ªõi d·∫°ng 'name' (gi·∫£ ƒë·ªãnh API PUT c·∫ßn 'name')
              language: currentLanguage,
              price: newPriceFloat,
            }),
          })
            .then((response) => {
              if (!response.ok) {
                return response.json().then((err) => {
                  throw new Error(err.error || "L·ªói c·∫≠p nh·∫≠t server.");
                });
              }
              return response.json();
            })
            .then((result) => {
              showAlert(result.message, "success");
              loadCourses(); // T·∫£i l·∫°i danh s√°ch
            })
            .catch((error) => {
              showAlert(`L·ªói c·∫≠p nh·∫≠t Kh√≥a h·ªçc: ${error.message}`, "danger");
            });
        } else if (newPrice !== null) {
          showAlert("L·ªói: Gi√° nh·∫≠p v√†o kh√¥ng h·ª£p l·ªá ho·∫∑c b·ªã h·ªßy.", "warning");
        }
      }

      // H√†m X√≥a Kh√≥a h·ªçc
      function deleteCourse(courseId) {
        if (
          !confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA Kh√≥a h·ªçc ID ${courseId} kh√¥ng?`)
        ) {
          return;
        }

        fetch(`${COURSE_API_URL}/${courseId}`, {
          method: "DELETE",
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((err) => {
                throw new Error(err.error || "L·ªói x√≥a server.");
              });
            }
            return response.json();
          })
          .then((result) => {
            showAlert(result.message, "success");
            loadCourses(); // T·∫£i l·∫°i danh s√°ch
          })
          .catch((error) => {
            showAlert(`L·ªói khi x√≥a Kh√≥a h·ªçc: ${error.message}`, "danger");
          });
      }

      // --- LOGIC T·∫¢I KH√ìA H·ªåC (Th·ªß t·ª•c 2.3) ---

      async function loadCourses() {
        const teacherId = document.getElementById("searchTeacherId").value;
        const maxPrice = document.getElementById("searchMaxPrice").value;
        courseTableBody.innerHTML =
          '<tr><td colspan="5" class="text-center">ƒêang t·∫£i...</td></tr>';

        if (isNaN(teacherId) || teacherId <= 0) {
          courseTableBody.innerHTML =
            '<tr><td colspan="5" class="text-center alert-danger">L·ªói: Teacher ID kh√¥ng h·ª£p l·ªá.</td></tr>';
          return;
        }

        try {
          const response = await fetch(
            `${API_URL}/courses/${teacherId}?maxPrice=${maxPrice}`
          );
          const result = await response.json();

          courseTableBody.innerHTML = "";

          if (response.ok) {
            currentCourses = result.data || []; // L∆∞u d·ªØ li·ªáu g·ªëc

            if (currentCourses.length > 0) {
              currentCourses.forEach((course) => {
                const row = courseTableBody.insertRow();

                // HI·ªÇN TH·ªä D·ªÆ LI·ªÜU: S·ª≠ d·ª•ng t√™n thu·ªôc t√≠nh c≈©: courseId, courseName
                row.insertCell().textContent = course.courseId; // ID Kh√≥a h·ªçc
                row.insertCell().textContent = course.courseName; // T√™n Kh√≥a h·ªçc
                row.insertCell().textContent = `$${(
                  course.price || 0
                ).toLocaleString("en-US")}`;

                // Gi·∫£ ƒë·ªãnh t√™n Gi√°o vi√™n
                row.insertCell().textContent =
                  course.teacherName || "ID: " + teacherId;

                // CELL THAO T√ÅC
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="btn btn-sm btn-info btn-action" onclick="editCourse(${course.courseId})" title="S·ª≠a Kh√≥a h·ªçc">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger btn-action" onclick="deleteCourse(${course.courseId})" title="X√≥a Kh√≥a h·ªçc">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
              });
            } else {
              courseTableBody.innerHTML =
                '<tr><td colspan="5" class="text-center">Kh√¥ng t√¨m th·∫•y kh√≥a h·ªçc n√†o.</td></tr>';
            }
          } else {
            courseTableBody.innerHTML = `<tr><td colspan="5" class="text-center alert-danger">L·ªói: ${result.error}</td></tr>`;
          }
        } catch (error) {
          courseTableBody.innerHTML = `<tr><td colspan="5" class="text-center alert-danger">L·ªói k·∫øt n·ªëi: ${error.message}</td></tr>`;
        }
      }

      document
        .getElementById("btnSearchCourses")
        .addEventListener("click", loadCourses);

      // T·∫£i danh s√°ch l·∫ßn ƒë·∫ßu
      loadCourses();
    </script>
  </body>
</html>
